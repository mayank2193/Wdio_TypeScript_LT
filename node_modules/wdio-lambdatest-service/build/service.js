"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _nodeRestClient = _interopRequireDefault(require("@lambdatest/node-rest-client"));

var _logger = _interopRequireDefault(require("@wdio/logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const log = (0, _logger.default)('@wdio/lambdatest-service');

class LambdaRestService {
  constructor() {
    this.testCnt = 0;
    this.failures = 0;
  }

  beforeSession(config, capabilities) {
    this.config = config;
    this.capabilities = capabilities;
    const lambdaCredentials = {
      username: this.config.user,
      accessKey: this.config.key,
      isApp: false
    };
    if (this.config.product === 'appAutomation') lambdaCredentials.isApp = true;

    if (this.config.logFile) {
      lambdaCredentials.logFile = this.config.logFile;
    }

    this.isServiceEnabled = lambdaCredentials.username && lambdaCredentials.accessKey;

    try {
      this.api = _nodeRestClient.default.AutomationClient(lambdaCredentials);
    } catch (_) {
      this.isServiceEnabled = false;
    }
  }

  beforeScenario(world) {
    if (!!!this.suiteTitle) {
      this.suiteTitle = world.pickle.name || 'unknown scenario';
    }
  }

  beforeSuite(suite) {
    this.suiteTitle = suite.title;
  }

  beforeTest(test) {
    if (!this.isServiceEnabled) {
      return;
    }

    if (test.title && !!!this.testTitle) {
      this.testTitle = test.title;
    }

    if (this.suiteTitle === 'Jasmine__TopLevel__Suite') {
      this.suiteTitle = test.fullName;
    }
  }

  afterSuite(suite) {
    if (Object.prototype.hasOwnProperty.call(suite, 'error')) {
      ++this.failures;
    }
  }

  afterTest(test, context, {
    error,
    result,
    duration,
    passed,
    retries
  }) {
    console.log(error, result, duration, retries);

    if (!passed) {
      ++this.failures;
    }
  }

  afterScenario(world, {
    passed,
    error,
    duration
  }) {
    console.log(error, duration);

    if (!passed) {
      ++this.failures;
    }
  }

  after(result) {
    if (!this.isServiceEnabled) {
      return;
    }

    let failures = this.failures;

    if (global.browser.config.mochaOpts && global.browser.config.mochaOpts.bail && Boolean(result)) {
      failures = 1;
    }

    console.log("=========result=========", result, result === 0);

    if (result === 0) {
      failures = 0;
    }

    const status = 'status: ' + (failures > 0 ? 'failed' : 'passed');

    if (!global.browser.isMultiremote) {
      log.info(`Update job with sessionId ${global.browser.sessionId}, ${status}`);
      return this._update(global.browser.sessionId, failures);
    }

    return Promise.all(Object.keys(this.capabilities).map(browserName => {
      log.info(`Update multiremote job for browser '${browserName}' and sessionId ${global.browser[browserName].sessionId}, ${status}`);
      return this._update(global.browser[browserName].sessionId, failures, false, browserName);
    }));
  }

  onReload(oldSessionId, newSessionId) {
    if (!this.isServiceEnabled) {
      return;
    }

    const status = 'status: ' + (this.failures > 0 ? 'failed' : 'passed');

    if (!global.browser.isMultiremote) {
      log.info(`Update (reloaded) job with sessionId ${oldSessionId}, ${status}`);
      return this._update(oldSessionId, this.failures, true);
    }

    const browserName = global.browser.instances.filter(browserName => global.browser[browserName].sessionId === newSessionId)[0];
    log.info(`Update (reloaded) multiremote job for browser '${browserName}' and sessionId ${oldSessionId}, ${status}`);
    return this._update(oldSessionId, this.failures, true, browserName);
  }

  async _update(sessionId, failures, calledOnReload = false, browserName) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    await sleep(5000);
    return await this.updateJob(sessionId, failures, calledOnReload, browserName);
  }

  async updateJob(sessionId, failures, calledOnReload = false, browserName) {
    const body = this.getBody(failures, calledOnReload, browserName);

    try {
      await new Promise((resolve, reject) => {
        this.api.updateSessionById(sessionId, body, (err, result) => {
          if (err) {
            return reject(err);
          }

          return resolve(result);
        });
      });
    } catch (ex) {
      console.log(ex);
    }

    this.failures = 0;
  }

  getBody(failures, calledOnReload = false, browserName) {
    let body = {};

    if (!(!global.browser.isMultiremote && this.capabilities.name || global.browser.isMultiremote && this.capabilities[browserName].capabilities.name)) {
      let testName = this.suiteTitle;

      if (this.testTitle) {
        testName = testName + ' - ' + this.testTitle;
      }

      body.name = testName;

      if (this.capabilities['LT:Options'] && this.capabilities['LT:Options'].name) {
        body.name = this.capabilities['LT:Options'].name;
      }

      if (browserName) {
        body.name = `${browserName}: ${body.name}`;
      }

      if (calledOnReload || this.testCnt) {
        let testCnt = ++this.testCnt;

        if (global.browser.isMultiremote) {
          testCnt = Math.ceil(testCnt / global.browser.instances.length);
        }

        body.name += ` (${testCnt})`;
      }
    }

    body.status_ind = failures > 0 ? 'failed' : 'passed';
    return body;
  }

}

exports.default = LambdaRestService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLmpzIl0sIm5hbWVzIjpbImxvZyIsIkxhbWJkYVJlc3RTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJ0ZXN0Q250IiwiZmFpbHVyZXMiLCJiZWZvcmVTZXNzaW9uIiwiY29uZmlnIiwiY2FwYWJpbGl0aWVzIiwibGFtYmRhQ3JlZGVudGlhbHMiLCJ1c2VybmFtZSIsInVzZXIiLCJhY2Nlc3NLZXkiLCJrZXkiLCJpc0FwcCIsInByb2R1Y3QiLCJsb2dGaWxlIiwiaXNTZXJ2aWNlRW5hYmxlZCIsImFwaSIsIkxhbWJkYVJlc3RDbGllbnQiLCJBdXRvbWF0aW9uQ2xpZW50IiwiXyIsImJlZm9yZVNjZW5hcmlvIiwid29ybGQiLCJzdWl0ZVRpdGxlIiwicGlja2xlIiwibmFtZSIsImJlZm9yZVN1aXRlIiwic3VpdGUiLCJ0aXRsZSIsImJlZm9yZVRlc3QiLCJ0ZXN0IiwidGVzdFRpdGxlIiwiZnVsbE5hbWUiLCJhZnRlclN1aXRlIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiYWZ0ZXJUZXN0IiwiY29udGV4dCIsImVycm9yIiwicmVzdWx0IiwiZHVyYXRpb24iLCJwYXNzZWQiLCJyZXRyaWVzIiwiY29uc29sZSIsImFmdGVyU2NlbmFyaW8iLCJhZnRlciIsImdsb2JhbCIsImJyb3dzZXIiLCJtb2NoYU9wdHMiLCJiYWlsIiwiQm9vbGVhbiIsInN0YXR1cyIsImlzTXVsdGlyZW1vdGUiLCJpbmZvIiwic2Vzc2lvbklkIiwiX3VwZGF0ZSIsIlByb21pc2UiLCJhbGwiLCJrZXlzIiwibWFwIiwiYnJvd3Nlck5hbWUiLCJvblJlbG9hZCIsIm9sZFNlc3Npb25JZCIsIm5ld1Nlc3Npb25JZCIsImluc3RhbmNlcyIsImZpbHRlciIsImNhbGxlZE9uUmVsb2FkIiwic2xlZXAiLCJtcyIsInIiLCJzZXRUaW1lb3V0IiwidXBkYXRlSm9iIiwiYm9keSIsImdldEJvZHkiLCJyZXNvbHZlIiwicmVqZWN0IiwidXBkYXRlU2Vzc2lvbkJ5SWQiLCJlcnIiLCJleCIsInRlc3ROYW1lIiwiTWF0aCIsImNlaWwiLCJsZW5ndGgiLCJzdGF0dXNfaW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLE1BQU1BLEdBQUcsR0FBRyxxQkFBTywwQkFBUCxDQUFaOztBQUVlLE1BQU1DLGlCQUFOLENBQXdCO0FBQ3JDQyxFQUFBQSxXQUFXLEdBQUc7QUFDWixTQUFLQyxPQUFMLEdBQWUsQ0FBZjtBQUNBLFNBQUtDLFFBQUwsR0FBZ0IsQ0FBaEI7QUFDRDs7QUFFREMsRUFBQUEsYUFBYSxDQUFDQyxNQUFELEVBQVNDLFlBQVQsRUFBdUI7QUFDbEMsU0FBS0QsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsWUFBTCxHQUFvQkEsWUFBcEI7QUFDQSxVQUFNQyxpQkFBaUIsR0FBRztBQUN4QkMsTUFBQUEsUUFBUSxFQUFFLEtBQUtILE1BQUwsQ0FBWUksSUFERTtBQUV4QkMsTUFBQUEsU0FBUyxFQUFFLEtBQUtMLE1BQUwsQ0FBWU0sR0FGQztBQUd4QkMsTUFBQUEsS0FBSyxFQUFHO0FBSGdCLEtBQTFCO0FBTUEsUUFBSSxLQUFLUCxNQUFMLENBQVlRLE9BQVosS0FBd0IsZUFBNUIsRUFBNkNOLGlCQUFpQixDQUFDSyxLQUFsQixHQUF5QixJQUF6Qjs7QUFFN0MsUUFBSSxLQUFLUCxNQUFMLENBQVlTLE9BQWhCLEVBQXlCO0FBQ3ZCUCxNQUFBQSxpQkFBaUIsQ0FBQ08sT0FBbEIsR0FBNEIsS0FBS1QsTUFBTCxDQUFZUyxPQUF4QztBQUNEOztBQUVELFNBQUtDLGdCQUFMLEdBQXdCUixpQkFBaUIsQ0FBQ0MsUUFBbEIsSUFBOEJELGlCQUFpQixDQUFDRyxTQUF4RTs7QUFFQSxRQUFJO0FBQ0YsV0FBS00sR0FBTCxHQUFXQyx3QkFBaUJDLGdCQUFqQixDQUFrQ1gsaUJBQWxDLENBQVg7QUFDRCxLQUZELENBRUUsT0FBT1ksQ0FBUCxFQUFVO0FBQ1YsV0FBS0osZ0JBQUwsR0FBd0IsS0FBeEI7QUFDRDtBQUNG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R0FBRXFDLFdBQVksS0FBSVksSUFBSSxDQUFDakQsSUFBSyxFQUF6QztBQUNEOztBQUVELFVBQUkyQyxjQUFjLElBQUksS0FBS2pFLE9BQTNCLEVBQW9DO0FBQ2xDLFlBQUlBLE9BQU8sR0FBRyxFQUFFLEtBQUtBLE9BQXJCOztBQUVBLFlBQUk2QyxNQUFNLENBQUNDLE9BQVAsQ0FBZUssYUFBbkIsRUFBa0M7QUFDaENuRCxVQUFBQSxPQUFPLEdBQUcrRSxJQUFJLENBQUNDLElBQUwsQ0FBVWhGLE9BQU8sR0FBRzZDLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlaUIsU0FBZixDQUF5QmtCLE1BQTdDLENBQVY7QUFDRDs7QUFFRFYsUUFBQUEsSUFBSSxDQUFDakQsSUFBTCxJQUFjLEtBQUl0QixPQUFRLEdBQTFCO0FBQ0Q7QUFDRjs7QUFFRHVFLElBQUFBLElBQUksQ0FBQ1csVUFBTCxHQUFrQmpGLFFBQVEsR0FBRyxDQUFYLEdBQWUsUUFBZixHQUEwQixRQUE1QztBQUNBLFdBQU9zRSxJQUFQO0FBQ0Q7O0FBbkxvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMYW1iZGFSZXN0Q2xpZW50IGZyb20gJ0BsYW1iZGF0ZXN0L25vZGUtcmVzdC1jbGllbnQnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcblxuY29uc3QgbG9nID0gbG9nZ2VyKCdAd2Rpby9sYW1iZGF0ZXN0LXNlcnZpY2UnKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYW1iZGFSZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMudGVzdENudCA9IDA7XG4gICAgdGhpcy5mYWlsdXJlcyA9IDA7XG4gIH1cblxuICBiZWZvcmVTZXNzaW9uKGNvbmZpZywgY2FwYWJpbGl0aWVzKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXRpZXM7XG4gICAgY29uc3QgbGFtYmRhQ3JlZGVudGlhbHMgPSB7XG4gICAgICB1c2VybmFtZTogdGhpcy5jb25maWcudXNlcixcbiAgICAgIGFjY2Vzc0tleTogdGhpcy5jb25maWcua2V5LFxuICAgICAgaXNBcHAgOiBmYWxzZVxuICAgIH07XG5cbiAgICBpZiAodGhpcy5jb25maWcucHJvZHVjdCA9PT0gJ2FwcEF1dG9tYXRpb24nKSBsYW1iZGFDcmVkZW50aWFscy5pc0FwcCA9dHJ1ZVxuXG4gICAgaWYgKHRoaXMuY29uZmlnLmxvZ0ZpbGUpIHtcbiAgICAgIGxhbWJkYUNyZWRlbnRpYWxzLmxvZ0ZpbGUgPSB0aGlzLmNvbmZpZy5sb2dGaWxlO1xuICAgIH1cblxuICAgIHRoaXMuaXNTZXJ2aWNlRW5hYmxlZCA9IGxhbWJkYUNyZWRlbnRpYWxzLnVzZXJuYW1lICYmIGxhbWJkYUNyZWRlbnRpYWxzLmFjY2Vzc0tleTtcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmFwaSA9IExhbWJkYVJlc3RDbGllbnQuQXV0b21hdGlvbkNsaWVudChsYW1iZGFDcmVkZW50aWFscyk7XG4gICAgfSBjYXRjaCAoXykge1xuICAgICAgdGhpcy5pc1NlcnZpY2VFbmFibGVkID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYmVmb3JlU2NlbmFyaW8od29ybGQpIHtcbiAgICBpZiAoISEhdGhpcy5zdWl0ZVRpdGxlKXtcbiAgICAgIHRoaXMuc3VpdGVUaXRsZSA9IHdvcmxkLnBpY2tsZS5uYW1lIHx8ICd1bmtub3duIHNjZW5hcmlvJ1xuICAgIH1cbiAgfVxuXG4gIGJlZm9yZVN1aXRlKHN1aXRlKSB7XG4gICAgdGhpcy5zdWl0ZVRpdGxlID0gc3VpdGUudGl0bGU7XG4gIH1cblxuICBiZWZvcmVUZXN0KHRlc3QpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGVzdC50aXRsZSAmJiAhISF0aGlzLnRlc3RUaXRsZSl7XG4gICAgICB0aGlzLnRlc3RUaXRsZSA9IHRlc3QudGl0bGVcbiAgICB9XG4gICAgXG4gICAgaWYgKHRoaXMuc3VpdGVUaXRsZSA9PT0gJ0phc21pbmVfX1RvcExldmVsX19TdWl0ZScpIHtcbiAgICAgIHRoaXMuc3VpdGVUaXRsZSA9IHRlc3QuZnVsbE5hbWU7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXJTdWl0ZShzdWl0ZSkge1xuICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3VpdGUsICdlcnJvcicpKSB7XG4gICAgICArK3RoaXMuZmFpbHVyZXM7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXJUZXN0KHRlc3QsIGNvbnRleHQsIHtcbiAgICBlcnJvcixcbiAgICByZXN1bHQsXG4gICAgZHVyYXRpb24sXG4gICAgcGFzc2VkLFxuICAgIHJldHJpZXNcbiAgfSkge1xuICAgIGNvbnNvbGUubG9nKGVycm9yLCByZXN1bHQsIGR1cmF0aW9uLCByZXRyaWVzKVxuICAgIGlmICghcGFzc2VkKSB7XG4gICAgICArK3RoaXMuZmFpbHVyZXM7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXJTY2VuYXJpbyh3b3JsZCwgeyBwYXNzZWQsIGVycm9yLCBkdXJhdGlvbiB9KSB7XG4gICAgY29uc29sZS5sb2coZXJyb3IsIGR1cmF0aW9uKVxuICAgIGlmICghcGFzc2VkKSB7XG4gICAgICArK3RoaXMuZmFpbHVyZXM7XG4gICAgfVxuICB9XG5cbiAgYWZ0ZXIocmVzdWx0KSB7XG4gICAgaWYgKCF0aGlzLmlzU2VydmljZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgZmFpbHVyZXMgPSB0aGlzLmZhaWx1cmVzO1xuXG4gICAgaWYgKGdsb2JhbC5icm93c2VyLmNvbmZpZy5tb2NoYU9wdHMgJiYgZ2xvYmFsLmJyb3dzZXIuY29uZmlnLm1vY2hhT3B0cy5iYWlsICYmIEJvb2xlYW4ocmVzdWx0KSkge1xuICAgICAgZmFpbHVyZXMgPSAxO1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhcIj09PT09PT09PXJlc3VsdD09PT09PT09PVwiLCByZXN1bHQsIHJlc3VsdCA9PT0gMClcbiAgICBpZiAocmVzdWx0ID09PSAwKSB7XG4gICAgICBmYWlsdXJlcyA9IDA7XG4gICAgfVxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAoZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJyk7XG5cbiAgICBpZiAoIWdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgIGxvZy5pbmZvKGBVcGRhdGUgam9iIHdpdGggc2Vzc2lvbklkICR7Z2xvYmFsLmJyb3dzZXIuc2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgICByZXR1cm4gdGhpcy5fdXBkYXRlKGdsb2JhbC5icm93c2VyLnNlc3Npb25JZCwgZmFpbHVyZXMpO1xuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChPYmplY3Qua2V5cyh0aGlzLmNhcGFiaWxpdGllcykubWFwKGJyb3dzZXJOYW1lID0+IHtcbiAgICAgIGxvZy5pbmZvKGBVcGRhdGUgbXVsdGlyZW1vdGUgam9iIGZvciBicm93c2VyICcke2Jyb3dzZXJOYW1lfScgYW5kIHNlc3Npb25JZCAke2dsb2JhbC5icm93c2VyW2Jyb3dzZXJOYW1lXS5zZXNzaW9uSWR9LCAke3N0YXR1c31gKTtcbiAgICAgIHJldHVybiB0aGlzLl91cGRhdGUoZ2xvYmFsLmJyb3dzZXJbYnJvd3Nlck5hbWVdLnNlc3Npb25JZCwgZmFpbHVyZXMsIGZhbHNlLCBicm93c2VyTmFtZSk7XG4gICAgfSkpO1xuICB9XG5cbiAgb25SZWxvYWQob2xkU2Vzc2lvbklkLCBuZXdTZXNzaW9uSWQpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAodGhpcy5mYWlsdXJlcyA+IDAgPyAnZmFpbGVkJyA6ICdwYXNzZWQnKTtcblxuICAgIGlmICghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSkge1xuICAgICAgbG9nLmluZm8oYFVwZGF0ZSAocmVsb2FkZWQpIGpvYiB3aXRoIHNlc3Npb25JZCAke29sZFNlc3Npb25JZH0sICR7c3RhdHVzfWApO1xuICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGJyb3dzZXJOYW1lID0gZ2xvYmFsLmJyb3dzZXIuaW5zdGFuY2VzLmZpbHRlcihicm93c2VyTmFtZSA9PiBnbG9iYWwuYnJvd3Nlclticm93c2VyTmFtZV0uc2Vzc2lvbklkID09PSBuZXdTZXNzaW9uSWQpWzBdO1xuICAgIGxvZy5pbmZvKGBVcGRhdGUgKHJlbG9hZGVkKSBtdWx0aXJlbW90ZSBqb2IgZm9yIGJyb3dzZXIgJyR7YnJvd3Nlck5hbWV9JyBhbmQgc2Vzc2lvbklkICR7b2xkU2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUsIGJyb3dzZXJOYW1lKTtcbiAgfVxuXG4gIGFzeW5jIF91cGRhdGUgKCBzZXNzaW9uSWQsIGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCA9IGZhbHNlLCBicm93c2VyTmFtZSApIHtcbiAgICBjb25zdCBzbGVlcCA9IG1zID0+IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtcykpO1xuICAgIFxuICAgIGF3YWl0IHNsZWVwKDUwMDApXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlSm9iKHNlc3Npb25JZCwgZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkLCBicm93c2VyTmFtZSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVKb2Ioc2Vzc2lvbklkLCBmYWlsdXJlcywgY2FsbGVkT25SZWxvYWQgPSBmYWxzZSwgYnJvd3Nlck5hbWUpIHtcbiAgICBjb25zdCBib2R5ID0gdGhpcy5nZXRCb2R5KGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCwgYnJvd3Nlck5hbWUpO1xuICAgIHRyeXtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmFwaS51cGRhdGVTZXNzaW9uQnlJZChzZXNzaW9uSWQsIGJvZHksIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoKGV4KXtcbiAgICBjb25zb2xlLmxvZyhleCk7XG4gIH1cbiAgICB0aGlzLmZhaWx1cmVzID0gMDtcbiAgfVxuXG4gIGdldEJvZHkoZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkID0gZmFsc2UsIGJyb3dzZXJOYW1lKSB7XG4gICAgbGV0IGJvZHkgPSB7fTtcbiAgICBpZiAoISghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSAmJiB0aGlzLmNhcGFiaWxpdGllcy5uYW1lIHx8IGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUgJiYgdGhpcy5jYXBhYmlsaXRpZXNbYnJvd3Nlck5hbWVdLmNhcGFiaWxpdGllcy5uYW1lKSkge1xuICAgICAgbGV0IHRlc3ROYW1lID0gdGhpcy5zdWl0ZVRpdGxlXG4gICAgICBpZiAodGhpcy50ZXN0VGl0bGUpe1xuICAgICAgICB0ZXN0TmFtZSA9IHRlc3ROYW1lICsgJyAtICcgKyB0aGlzLnRlc3RUaXRsZTtcbiAgICAgIH1cbiAgICAgIGJvZHkubmFtZSA9IHRlc3ROYW1lXG4gICAgICBcbiAgICAgIGlmICh0aGlzLmNhcGFiaWxpdGllc1snTFQ6T3B0aW9ucyddICYmIHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZSl7XG4gICAgICAgIGJvZHkubmFtZSA9IHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZVxuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgYm9keS5uYW1lID0gYCR7YnJvd3Nlck5hbWV9OiAke2JvZHkubmFtZX1gO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2FsbGVkT25SZWxvYWQgfHwgdGhpcy50ZXN0Q250KSB7XG4gICAgICAgIGxldCB0ZXN0Q250ID0gKyt0aGlzLnRlc3RDbnQ7XG5cbiAgICAgICAgaWYgKGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgICAgICB0ZXN0Q250ID0gTWF0aC5jZWlsKHRlc3RDbnQgLyBnbG9iYWwuYnJvd3Nlci5pbnN0YW5jZXMubGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJvZHkubmFtZSArPSBgICgke3Rlc3RDbnR9KWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYm9keS5zdGF0dXNfaW5kID0gZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJztcbiAgICByZXR1cm4gYm9keTtcbiAgfVxuXG59XG4iXX0=